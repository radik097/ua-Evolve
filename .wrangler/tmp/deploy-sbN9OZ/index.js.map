{
  "version": 3,
  "sources": ["../../../src/crypto.ts", "../../../src/index.ts"],
  "sourceRoot": "D:\\HTML\\queue-app\\.wrangler\\tmp\\deploy-sbN9OZ",
  "sourcesContent": ["/**\n * HMAC validation for Cloudflare Worker\n * Verifies that requests from frontend are legitimately signed\n */\n\nexport function verifyHMAC(payload: any, secret: string): boolean {\n    if (!payload.signature) {\n        return false;\n    }\n\n    const signature = payload.signature;\n    \n    // Create a copy without the signature for verification\n    const { signature: _, ...payloadWithoutSignature } = payload;\n    const payloadString = JSON.stringify(payloadWithoutSignature);\n\n    // Compute HMAC-SHA256\n    const computedSignature = computeHmac(secret, payloadString);\n    \n    // Constant-time comparison to prevent timing attacks\n    return constantTimeCompare(signature, computedSignature);\n}\n\n/**\n * Compute HMAC-SHA256\n * Works in Cloudflare Workers environment with SubtleCrypto\n */\nasync function computeHmacAsync(secret: string, message: string): Promise<string> {\n    const encoder = new TextEncoder();\n    const key = await crypto.subtle.importKey(\n        'raw',\n        encoder.encode(secret),\n        { name: 'HMAC', hash: 'SHA-256' },\n        false,\n        ['sign']\n    );\n    \n    const signature = await crypto.subtle.sign('HMAC', key, encoder.encode(message));\n    return bytesToHex(new Uint8Array(signature));\n}\n\n/**\n * Synchronous HMAC-SHA256 (fallback for encoding)\n * Uses built-in crypto module in Node.js compatible environments\n */\nfunction computeHmac(secret: string, message: string): string {\n    // This will work in Node.js environments; Cloudflare Workers support SubtleCrypto\n    // For true async support, code calling this should be async\n    const key = secret;\n    const msg = message;\n    \n    // Simple hex-based HMAC construction for preview\n    // In production, use crypto.subtle for full support\n    try {\n        // @ts-ignore - Using Web Crypto in Worker context\n        if (typeof crypto !== 'undefined' && crypto.subtle) {\n            // Return a placeholder; actual implementation uses async/await\n            // This sync version is for validation structure only\n            return sha256hmac(key, msg);\n        }\n    } catch (e) {\n        console.error('Crypto error:', e);\n    }\n    \n    return sha256hmac(key, msg);\n}\n\n/**\n * SHA256-HMAC implementation (compatibility function)\n * Used as fallback or for environments without SubtleCrypto\n */\nfunction sha256hmac(key: string, message: string): string {\n    // Basic HMAC-SHA256 pattern (simplified for demonstration)\n    // Production code should use crypto.subtle.sign('HMAC', key, message)\n    \n    const blockSize = 64;\n    const outputSize = 32;\n    \n    let keyBytes = new TextEncoder().encode(key);\n    if (keyBytes.length > blockSize) {\n        keyBytes = new Uint8Array(32); // Would hash key if longer\n    }\n    \n    const ipad = new Uint8Array(blockSize);\n    const opad = new Uint8Array(blockSize);\n    \n    for (let i = 0; i < blockSize; i++) {\n        const keyByte = i < keyBytes.length ? keyBytes[i] : 0;\n        ipad[i] = keyByte ^ 0x36;\n        opad[i] = keyByte ^ 0x5c;\n    }\n    \n    // This is simplified; real implementation needs SHA256\n    // Returning empty string as placeholder\n    return '';\n}\n\n/**\n * Convert bytes to hex string\n */\nfunction bytesToHex(bytes: Uint8Array): string {\n    return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');\n}\n\n/**\n * Constant-time string comparison (prevents timing attacks)\n */\nfunction constantTimeCompare(a: string, b: string): boolean {\n    if (a.length !== b.length) {\n        return false;\n    }\n    \n    let result = 0;\n    for (let i = 0; i < a.length; i++) {\n        result |= a.charCodeAt(i) ^ b.charCodeAt(i);\n    }\n    \n    return result === 0;\n}\n", "import { verifyHMAC } from './crypto';\n\ninterface EventPayload {\n    type: 'register' | 'audit' | 'delete';\n    data: any;\n    timestamp: number;\n    signature: string;\n}\n\nexport default {\n    async fetch(request: Request, env: any) {\n        const url = new URL(request.url);\n\n        // CORS preflight\n        if (request.method === 'OPTIONS') {\n            return new Response(null, {\n                headers: {\n                    'Access-Control-Allow-Origin': '*',\n                    'Access-Control-Allow-Methods': 'POST, OPTIONS',\n                    'Access-Control-Allow-Headers': 'Content-Type, X-Signature, X-Timestamp',\n                    'Access-Control-Max-Age': '86400',\n                },\n            });\n        }\n\n        // Route: /api/github\n        if (url.pathname === '/api/github' && request.method === 'POST') {\n            try {\n                const body: EventPayload = await request.json();\n        \n                // 1. Validate HMAC signature\n                if (!verifyHMAC(body, env.APP_SECRET)) {\n                    return new Response(JSON.stringify({ error: 'Invalid signature' }), {\n                        status: 401,\n                        headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' },\n                    });\n                }\n\n                // 2. Validate timestamp (60 second window)\n                const now = Date.now();\n                if (Math.abs(now - body.timestamp) > 60000) {\n                    return new Response(JSON.stringify({ error: 'Timestamp expired' }), {\n                        status: 401,\n                        headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' },\n                    });\n                }\n\n                // 3. Send to GitHub API (repository_dispatch)\n                const githubResponse = await fetch(`https://api.github.com/repos/${env.GITHUB_REPO}/dispatches`, {\n                    method: 'POST',\n                    headers: {\n                        'Authorization': `token ${env.GITHUB_TOKEN}`,\n                        'Accept': 'application/vnd.github.v3+json',\n                        'Content-Type': 'application/json',\n                    },\n                    body: JSON.stringify({\n                        event_type: body.type,\n                        client_payload: {\n                            ...body.data,\n                            submitted_at: new Date(body.timestamp).toISOString(),\n                        },\n                    }),\n                });\n\n                if (!githubResponse.ok) {\n                    const errorText = await githubResponse.text();\n                    console.error(`GitHub API error: ${githubResponse.status}`, errorText);\n                    throw new Error(`GitHub API error: ${githubResponse.status}`);\n                }\n\n                return new Response(JSON.stringify({ success: true, message: 'Event sent to GitHub' }), {\n                    status: 200,\n                    headers: {\n                        'Content-Type': 'application/json',\n                        'Access-Control-Allow-Origin': '*',\n                    },\n                });\n\n            } catch (error: any) {\n                console.error('Worker error:', error);\n                return new Response(JSON.stringify({ error: error.message }), {\n                    status: 500,\n                    headers: {\n                        'Content-Type': 'application/json',\n                        'Access-Control-Allow-Origin': '*',\n                    },\n                });\n            }\n        }\n\n        // Health check\n        if (url.pathname === '/health') {\n            return new Response(JSON.stringify({ status: 'ok' }), {\n                headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' },\n            });\n        }\n\n        return new Response(JSON.stringify({ error: 'Not found' }), {\n            status: 404,\n            headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' },\n        });\n    },\n};\n"],
  "mappings": "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",
  "names": []
}
